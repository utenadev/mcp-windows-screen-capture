# コードベース・レビュー報告書 (2026-02-07)

ドキュメントの再構成およびコードベースの分析を通じて特定された、改善点と指摘事項をまとめます。

## 1. 技術的指摘事項

### モニターのホットプラグ対応
- **現状**: `ScreenCaptureService` は起動時に `InitializeMonitors()` でモニター情報を初期化しています。
- **課題**: サーバー実行中にディスプレイが接続または切断された場合、モニターリストが古くなり、インデックスによるキャプチャが失敗したり、意図しないディスプレイを対象にしたりする可能性があります。
- **提案**: `ListMonitors` 実行時に情報を更新するか、明示的な再スキャン機能を実装することを検討してください。

### ウィンドウキャプチャの制限
- **現状**: GDI+ の `CopyFromScreen` および `PrintWindow` (`PW_RENDERFULLCONTENT`) を使用しています。
- **課題**: 最小化されたウィンドウを確実にキャプチャすることができません。また、ブラウザや Electron アプリなどのハードウェアアクセラレーションが有効なウィンドウでは、OS の状態によって黒い画面が返ることがあります。
- **提案**: これらの制限をドキュメントで明確に周知してください（`DEVELOPMENT.md` に一部追記済み）。将来的に Phase 2 の `Windows.Graphics.Capture` へ移行することで、これらの多くが解決される見込みです。

### オーディオセッションの管理
- **現状**: `AudioCaptureService` がセッションを管理し、手動の停止に依存しています。
- **課題**: クライアントが `stop_audio_capture` を呼び出さずに切断した場合、一時的な WAV ファイルが `%TEMP%` ディレクトリに蓄積される可能性があります。
- **提案**: `IHostApplicationLifetime` を利用して、サーバー終了時に一時ファイルを確実に削除するクリーンアップ処理の実装を検討してください。

### Whisper のパフォーマンス
- **現状**: `Whisper.net` による CPU 実行。
- **課題**: 日本語の文字起こしにおいて、`small` モデルは精度が高い反面、低スペックの CPU では処理に時間がかかる場合があります。
- **提案**: 将来的なフェーズとして、Vulkan や CUDA による GPU 加速の導入を検討してください。

## 2. ドキュメントと整合性

### 実装とドキュメントの乖離
- **発見した問題**: `README` 内の `capture` ツールの引数に、実装には存在しない `format` が記載され、一方で重要な `quality` の記載が漏れていました。
- **修正内容**: `docs/TOOLS.md` への移行に伴い、`ScreenCaptureTools.cs` の実装と完全に一致するように修正しました。

### ログ出力の標準
- **評価**: 本プロジェクトではログ出力に `Console.Error.WriteLine` を使用しており、MCP の `stdio` トランスポートを破壊しないよう適切に実装されています。これは非常に重要な規約です。
- **継続**: 今後の開発でもこの規約が維持されるよう、`GEMINI.md` に明記しました。

## 3. 今後のロードマップへの提案

1.  **Phase 2 の完全実装**: `Windows.Graphics.Capture` を利用した `ModernCaptureService` を完成させ、パフォーマンスと互換性を向上させる。
2.  **通知ベースのストリーミング**: MCP の通知（Notifications）をより活用し、サイドカーとしての HTTP サーバーなしでも効率的な画面監視ができる仕組みを強化する。
3.  **モデル管理ツール**: ディスク容量を節約するため、ダウンロード済みの Whisper モデルを削除または管理するツールの追加。