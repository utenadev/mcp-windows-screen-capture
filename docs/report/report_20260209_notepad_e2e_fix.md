# E2Eテストにおけるメモ帳操作とクリーンアップの改善報告

## 1. 目的
E2Eテストにおいて、メモ帳（Notepad.exe）を使用したテストを安定化させ、テスト終了後に確実にウィンドウを閉じる仕組みを構築する。

## 2. 実施した対応

### 2.1 サーバー側の機能追加
- **`close_window` ツールの追加**: 指定されたウィンドウハンドル（HWND）からプロセスIDを特定し、そのプロセスツリー全体を強制終了する機能を実装。
- **P/Invokeの追加**: `user32.dll` の `GetWindowThreadProcessId` を使用して、ウィンドウからプロセスを逆引きできるようにした。

### 2.2 E2Eテストコードの修正 (`McpE2ETests.cs`)
- **`OneTimeSetUp` / `OneTimeTearDown` の導入**: 
    - テスト開始時に一度だけ新しいメモ帳を起動。
    - テスト終了時に記録したHWNDおよび新規プロセスIDを元にクリーンアップを実行。
- **既存プロセスの保護**: テスト開始前に存在していたメモ帳プロセスをPIDで記録し、誤って終了させないようにした。
- **ウィンドウ特定の安定化**: `list_windows` ツールの結果からメモ帳を特定するロジックにリトライ処理を追加。

### 2.3 セキュリティ方針の再確認と適用
- `CHANGELOG.md` のセキュリティ制限に従い、一度検討した `keyboard_type` ツールや修飾キー（Ctrl, Alt, Shift）の許可を撤回。
- 許可されたナビゲーションキーのみを使用するテストケースに限定。

## 3. 現在発生している問題
- **ウィンドウが閉じない**: 複数のクリーンアップロジック（HWND経由の終了、PIDベースのKill）を実装したが、ユーザー環境（Windows 11）においてメモ帳ウィンドウが残存する現象が解消されていない。
- **ウィンドウ特定失敗**: `list_windows` において、起動したメモ帳のタイトルが取得できず（空文字）、HWNDを正しく特定できていないケースが確認された。

## 4. 推測される原因
- **Windows 11 メモ帳の特殊な構造**: ストアアプリ版メモ帳は、UIを表示するプロセスとバックエンドプロセスが分かれており、単純な `Process.Kill` や HWNDからの特定が標準的なWin32アプリと異なる可能性がある。
- **ウィンドウ階層**: `EnumWindows` で列挙される最上位ウィンドウ以外の場所に、実際の操作対象ウィンドウが存在している可能性がある。

## 5. 今後の対策案
- **`WM_CLOSE` メッセージの送信**: プロセスKillではなく、標準的なウィンドウ終了メッセージを送信するツールの検討。
- **プロセスツリーのより詳細な追跡**: 起動したスタブプロセスが生成した子プロセスをより確実に追跡する。
- **`list_windows` のデバッグ**: タイトルが空になる問題を調査し、クラス名（"Notepad"等）での特定を検討する。
